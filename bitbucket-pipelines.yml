image: bemiteu/webbuild:release-0.3

#
# Defaults

options:
  max-time: 10

clone:
  depth: 1

#
## Reusable Steps, define only one step per var (thus no hyphen)

build: &build
  step:
    name: Build
    caches:
      - node
    script:
      - npm install
      - npm run build
      - rsync -av --exclude='.git' --exclude='node_modules' . ../build_tmp
      - mv ../build_tmp ./build
    artifacts:
      - build/**

publish: &publish
  step:
    name: Publish
    script:
      - rm -rf build/**
      - rm -rf test-reports/**
      - npmPublish.sh

artifactSave: &artifactSave
  step:
    name: Artifact Save
    script:
      - zip -r build.zip ./build
      - saveDownloadBranch.sh build.zip
    artifacts:
      - build.zip

artifactSaveTag: &artifactSaveTag
  step:
    name: Artifact Save
    script:
      - zip -r build.zip ./build
      - saveDownloadTag.sh build.zip
    artifacts:
      - build.zip

#
## Actual Pipeline

pipelines:
  default:
    - <<: *build
  tags:
    '*.*.*':
      - <<: *build
      - parallel:
        - <<: *artifactSaveTag
        - <<: *publish
  branches:
    master:
      - <<: *build
      - <<: *artifactSave
      - step:
          name: Deploy Production
          deployment: production
          script:
            # todo: fix certificate error on alpine-lftps, not possible to load pipeline runners ca to authenticate the receiving
            - lftp -d -e "set ssl:verify-certificate no; mirror --reverse --delete ./dist/sassdoc $PROD_FTP_TARGET_PATH; quit" -p $PROD_FTP_PORT -u $PROD_FTP_USERNAME,$PROD_FTP_PASSWORD $PROD_FTP_TARGET_SITE
    develop:
      - <<: *build
      - <<: *artifactSave
      - step:
          name: Deploy Nightly
          deployment: staging
          script:
            # todo: fix certificate error on alpine-lftps, not possible to load pipeline runners ca to authenticate the receiving
            - lftp -d -e "set ssl:verify-certificate no; mirror --reverse --delete ./dist/sassdoc $NIGHT_FTP_TARGET_PATH; quit" -p $NIGHT_FTP_PORT -u $NIGHT_FTP_USERNAME,$NIGHT_FTP_PASSWORD $NIGHT_FTP_TARGET_SITE
    feature/*:
      - <<: *build
